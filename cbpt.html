\<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battle Points Tracker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #results {
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 20px;
            height: 300px; /* Fixed height */
            overflow-y: scroll; /* Enable scrolling */
        }
    </style>
</head>
<body>

    <h1>Battle Points Tracker</h1>
    <button id="runScript">Run Script</button>

    <div id="results"></div>

    <script src="script.js"></script>
    <script>
        // Reference to the results div
        const resultsDiv = document.getElementById('results');

        // Function to append output to results div
        function appendToResults(output) {
            resultsDiv.innerHTML += `<div>${output}</div>`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight; // Scroll to the bottom
        }

        // Modify your existing functions to use appendToResults instead of console.log
        async function fetch_and_display_user_data() {
            let alert = "";

            const max_points_length = Math.max(...data.users.map(user => user.current_points.toLocaleString().length));

            for (const user of data.users) {
                const data_from_api = await fetch_user_points(user);

                await new Promise(resolve => setTimeout(resolve, 50));

                if ("data" in data_from_api && BATTLE_TYPE in data_from_api.data.Battles) {
                    const battle_data = data_from_api.data.Battles[BATTLE_TYPE];
                    const user_points = battle_data.PointContributions.find(item => item.UserID === user.id)?.Points;

                    if (user_points === undefined) {
                        appendToResults(`User ${user.name} not found in battle ${BATTLE_TYPE} for clan ${user.clan}`);
                        continue;
                    }

                    if (user.last_points === 0) {
                        user.last_points = user_points;
                        user.current_points = user_points;

                        const current_points_str = user_points.toLocaleString();
                        appendToResults(print_user_data(user, current_points_str, "", max_points_length));
                        continue;
                    }

                    update_user_points(user, user_points);

                    if (user.current_points - user.last_points === 0) {
                        user.consecutive_zeros += 1;
                    } else {
                        user.consecutive_zeros = 0;
                    }

                    if (user.consecutive_zeros >= ZERO_POINTS_THRESHOLD) {
                        alert += `\n${user.name} has ${ZERO_POINTS_THRESHOLD} consecutive 0-point increases!\nOpening URL...\n`;
                        appendToResults(`Opening URL: ${ZERO_POINTS_URL}`);
                        user.consecutive_zeros = 0; // Reset after alert
                        await new Promise(resolve => setTimeout(resolve, 60000)); // Wait before next check
                    }

                    const points_difference = user.current_points - user.last_points;
                    const huge_suffix = Math.abs(points_difference) > 250 ? " Huge!?" : "";
                    if (huge_suffix) huge_suffix_count += 1;

                    const current_points_str = user.current_points.toLocaleString();
                    const points_difference_str = points_difference !== 0 ? `${points_difference >= 0 ? '+' : ''}${points_difference}${huge_suffix}` : "";
                    
                    appendToResults(print_user_data(user, current_points_str, points_difference_str, max_points_length));
                } else {
                    appendToResults(`Battle ${BATTLE_TYPE} not found!`);
                }
            }

            const spaces_huges = alignment_spaces(data.labels.huges);
            appendToResults(`${data.labels.huges}${spaces_huges}: ${huge_suffix_count}`);

            if (alert) {
                appendToResults(alert);
            }
        }

        function print_user_data(user, current_points_str, points_difference, max_points_length) {
            const spaces_name = alignment_spaces(user.name || 'Unknown');
            const spaces_points = alignment_spaces_for_points(current_points_str, max_points_length);
            
            let output = `${user.name}${spaces_name}: ${current_points_str}${spaces_points}`;
            if (points_difference) {
                output += ` (${points_difference})`;
            }
            return output;
        }

        // Update main function to call fetch_and_display_user_data when the button is clicked
        document.getElementById('runScript').addEventListener('click', async () => {
            resultsDiv.innerHTML = ""; // Clear previous results
            await fetch_and_display_user_data();
        });
    </script>
</body>
</html>
